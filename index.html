<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Mestre de Retenção: Engenharia da Memória para o Inglês</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #1f2937;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease;
        }
        .button-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .button-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .button-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .input-style {
            padding: 0.6rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-style:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div id="app-container" class="max-w-4xl mx-auto space-y-8">
        <!-- Título e Status de Autenticação -->
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-blue-800">Plano Mestre de Retenção</h1>
            <p class="text-xl text-gray-600 mt-1">Engenharia da Memória para o Inglês. Adeus, Decoreba!</p>
            <div id="auth-status" class="mt-4 p-3 rounded-lg shadow-md bg-white text-gray-700">
                <p>Seu progresso é salvo automaticamente neste ID de Usuário (salvo no seu Firestore):</p>
                <div id="user-id" class="font-mono text-sm mt-1 break-all">Aguardando autenticação...</div>
            </div>
        </header>

        <!-- Área de Mensagens de Erro/Status -->
        <div id="status-message" class="card hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700"></div>
        <div id="error-message" class="card hidden bg-red-100 border-l-4 border-red-500 text-red-700"></div>

        <!-- 1. Adicionar Vocabulário com Contexto -->
        <section class="card">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">1. Adicionar Vocabulário com Contexto</h2>
            <div class="space-y-4">
                <div>
                    <label for="new-word" class="block text-sm font-medium text-gray-700 mb-1">Palavra/Frase:</label>
                    <input type="text" id="new-word" class="input-style" placeholder="Ex: 'Ephemeral' ou 'To call it a day'">
                </div>
                <div>
                    <label for="new-context" class="block text-sm font-medium text-gray-700 mb-1">Contexto / Frase de Exemplo (Regra do Input Significativo):</label>
                    <input type="text" id="new-context" class="input-style" placeholder="Ex: 'The beauty of the cherry blossoms is ephemeral.'">
                </div>
                <button id="add-word-btn" class="button-primary w-full" disabled>
                    Adicionar Palavra (Início da Repetição Espaçada)
                </button>
            </div>
        </section>

        <!-- 2. Monitoramento de Retenção (Spaced Repetition) -->
        <section class="card">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">2. Monitoramento de Retenção (Spaced Repetition)</h2>
            <p class="text-gray-600 mb-4">Seu vocabulário, classificado por urgência de revisão.</p>

            <!-- Filtro de Visualização -->
            <div class="mb-4 flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4">
                <label for="filter-view" class="font-medium text-gray-700">Filtro de Visualização:</label>
                <select id="filter-view" class="input-style md:w-auto">
                    <option value="all">Todas</option>
                    <option value="today">Revisar Hoje</option>
                    <option value="mastered">Dominadas</option>
                </select>
                <p id="total-words-count" class="text-sm text-gray-500"></p>
            </div>

            <!-- Tabela de Vocabulário -->
            <div class="overflow-x-auto shadow-lg rounded-xl">
                <table class="min-w-full bg-white">
                    <thead class="bg-blue-500 text-white">
                        <tr>
                            <th class="p-3 text-left">Palavra</th>
                            <th class="p-3 text-left w-1/4">Próxima Revisão</th>
                            <th class="p-3 text-left hidden sm:table-cell">Nível</th>
                            <th class="p-3 text-left">Desafio (Recall)</th>
                            <th class="p-3 text-left">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="vocab-list">
                        <!-- Itens serão inseridos aqui pelo JavaScript -->
                        <tr id="loading-row">
                            <td colspan="5" class="p-4 text-center text-gray-500">
                                Carregando vocabulário...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Modal para o Desafio de Recall -->
    <div id="recall-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="card w-full max-w-lg space-y-4">
            <h3 class="text-xl font-bold text-blue-700">Desafio de Recall</h3>
            <p class="text-gray-700">Tente lembrar do significado e do contexto da palavra abaixo:</p>
            
            <div class="border-2 border-dashed border-blue-300 bg-blue-50 p-4 rounded-lg">
                <p class="text-2xl font-extrabold text-blue-900" id="modal-word"></p>
            </div>

            <button id="show-answer-btn" class="button-primary w-full">Revelar Resposta</button>
            
            <div id="answer-area" class="space-y-3 hidden">
                <p class="text-gray-700">Contexto/Exemplo:</p>
                <div class="p-3 bg-gray-100 rounded-lg italic text-gray-800" id="modal-context"></div>
                
                <p class="font-bold mt-4">Você se lembrou?</p>
                <div class="flex space-x-3">
                    <button data-level="1" class="recall-btn flex-1 p-3 text-white rounded-lg font-semibold bg-red-500 hover:bg-red-600 transition">Não Lembrei (0-1 dia)</button>
                    <button data-level="3" class="recall-btn flex-1 p-3 text-white rounded-lg font-semibold bg-yellow-500 hover:bg-yellow-600 transition">Com Dificuldade (3-7 dias)</button>
                    <button data-level="5" class="recall-btn flex-1 p-3 text-white rounded-lg font-semibold bg-green-500 hover:bg-green-600 transition">Fácil/Dominado (15+ dias)</button>
                </div>
            </div>
            
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 transition mt-2 w-full">Fechar</button>
        </div>
    </div>


    <!-- Firebase & App Logic -->
    <script type="module">
        // Importa módulos Firebase (versão 11.6.1 ou superior)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setLogLevel, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais (disponíveis no ambiente Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Instâncias Firebase
        let app, db, auth;
        let userId = null;
        let vocabData = [];
        let currentFilter = 'all';

        // --- UTILS E UI HANDLERS ---

        /** Exibe mensagens de erro em uma div dedicada, substituindo alert(). */
        function displayError(message) {
            const errorDiv = document.getElementById('error-message');
            const statusDiv = document.getElementById('status-message');
            errorDiv.textContent = `Erro FATAL: ${message}. Verifique o console para mais detalhes.`;
            errorDiv.classList.remove('hidden');
            statusDiv.classList.add('hidden');
            console.error(message);
        }

        /** Exibe mensagens de status/carregamento. */
        function displayStatus(message, isHidden = false) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.classList.toggle('hidden', isHidden);
        }
        
        /** Converte um objeto Timestamp do Firebase para uma string de data formatada. */
        function formatDate(timestamp) {
            const date = timestamp.toDate();
            // Formato dd/mm/aaaa
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return date.toLocaleDateString('pt-BR', options);
        }

        // --- LÓGICA DE REPETIÇÃO ESPAÇADA (SR) ---

        /** Calcula a próxima data de revisão baseada no nível atual. */
        function calculateNextReviewDate(currentLevel) {
            const now = new Date();
            let daysToAdd = 1;

            switch (currentLevel) {
                case 1: daysToAdd = 1; break;   // Errou/Não Lembrou
                case 2: daysToAdd = 3; break;   // Dificuldade
                case 3: daysToAdd = 7; break;   // Mediano
                case 4: daysToAdd = 15; break;  // Fácil
                case 5: daysToAdd = 30; break;  // Dominado (Mastered)
                default: daysToAdd = 1;
            }

            now.setDate(now.getDate() + daysToAdd);
            return now;
        }

        // --- FIREBASE E AUTENTICAÇÃO ---

        /** Tenta a autenticação usando o token ou anonimamente. */
        async function attemptAuthentication() {
            try {
                displayStatus("Autenticando...");
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                displayError(`Falha na autenticação: ${error.message}`);
                console.error("Erro ao autenticar:", error);
            }
        }

        /** Configura o listener de autenticação e carrega os dados. */
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = userId;
                    document.getElementById('add-word-btn').disabled = false;
                    displayStatus("Autenticação concluída. Carregando dados...");
                    setupDataListener();
                } else {
                    userId = null;
                    document.getElementById('user-id').textContent = 'Usuário Desconectado (Erro de Auth)';
                    document.getElementById('add-word-btn').disabled = true;
                    displayStatus("Usuário não autenticado. Apenas o modo anônimo está disponível.", true);
                    document.getElementById('loading-row').textContent = 'Faça login para salvar seu progresso.';
                }
            });
        }

        /** Configura o listener em tempo real para o vocabulário (onSnapshot). */
        function setupDataListener() {
            // Caminho da coleção privada do usuário: /artifacts/{appId}/users/{userId}/vocab
            const vocabColRef = collection(db, `artifacts/${appId}/users/${userId}/vocab`);
            const q = query(vocabColRef);

            onSnapshot(q, (snapshot) => {
                vocabData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    reviewDate: doc.data().reviewDate.toDate(), // Converte Firestore Timestamp para Data JS
                    level: doc.data().level || 1, // Garante que o nível exista
                }));
                
                displayStatus("Dados de vocabulário atualizados.", true);
                renderVocabList();
            }, (error) => {
                displayError(`Erro ao ouvir dados do Firestore: ${error.message}`);
                document.getElementById('loading-row').textContent = 'Erro ao carregar dados.';
            });
        }

        // --- FUNÇÕES CRUD E INTERAÇÃO ---

        /** Adiciona uma nova palavra ao Firestore. */
        async function addWord() {
            const word = document.getElementById('new-word').value.trim();
            const context = document.getElementById('new-context').value.trim();

            if (!word || !context) {
                displayStatus("Por favor, preencha a palavra/frase e o contexto.", false);
                return;
            }
            
            // Define a primeira revisão para amanhã (nível 1)
            const nextReview = calculateNextReviewDate(1);
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/vocab`), {
                    word,
                    context,
                    reviewDate: nextReview,
                    level: 1,
                    createdAt: new Date(),
                });
                
                document.getElementById('new-word').value = '';
                document.getElementById('new-context').value = '';
                displayStatus(`"${word}" adicionada com sucesso!`, true);
            } catch (error) {
                displayError(`Erro ao adicionar palavra: ${error.message}`);
            }
        }

        /** Atualiza o nível de retenção de uma palavra após o desafio. */
        async function updateWordRetention(vocabId, newLevel) {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/vocab`, vocabId);
            const nextReviewDate = calculateNextReviewDate(newLevel);
            
            try {
                await updateDoc(docRef, {
                    level: newLevel,
                    reviewDate: nextReviewDate,
                });
                displayStatus(`Progresso atualizado. Próxima revisão: ${formatDate(new Date(nextReviewDate))}.`, true);
            } catch (error) {
                displayError(`Erro ao atualizar retenção: ${error.message}`);
            }
        }

        /** Remove uma palavra do Firestore. */
        async function deleteWord(vocabId) {
            if (!confirm("Tem certeza que deseja remover esta palavra?")) return;
            
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/vocab`, vocabId);
            try {
                await deleteDoc(docRef);
                displayStatus("Palavra removida.", true);
            } catch (error) {
                displayError(`Erro ao deletar palavra: ${error.message}`);
            }
        }

        // --- RENDERIZAÇÃO DA INTERFACE ---

        /** Renderiza a lista de vocabulário na tabela. */
        function renderVocabList() {
            const container = document.getElementById('vocab-list');
            container.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Filtrar e ordenar dados (ordenar localmente para evitar problemas de índice no Firestore)
            let filteredData = vocabData;
            
            if (currentFilter === 'today') {
                filteredData = vocabData.filter(item => item.reviewDate <= today);
            } else if (currentFilter === 'mastered') {
                // Considera dominado como nível 5 ou mais
                filteredData = vocabData.filter(item => item.level >= 5);
            }

            // Ordenar por data de revisão (mais urgente primeiro)
            filteredData.sort((a, b) => a.reviewDate.getTime() - b.reviewDate.getTime());
            
            document.getElementById('total-words-count').textContent = `Total: ${vocabData.length} palavras. Mostrando: ${filteredData.length}.`;

            if (filteredData.length === 0) {
                container.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhuma palavra encontrada neste filtro.</td></tr>`;
                return;
            }

            filteredData.forEach(item => {
                const isUrgent = item.reviewDate <= today;
                const rowClass = isUrgent ? 'bg-red-50 hover:bg-red-100' : 'bg-white hover:bg-gray-50';
                const reviewText = isUrgent ? `<span class="font-bold text-red-600">REVISAR HOJE</span>` : formatDate(item.reviewDate);

                const row = `
                    <tr class="border-b ${rowClass}">
                        <td class="p-3 font-semibold text-gray-800">${item.word}</td>
                        <td class="p-3 text-sm">${reviewText}</td>
                        <td class="p-3 text-sm hidden sm:table-cell">Nível ${item.level}</td>
                        <td class="p-3">
                            <button data-id="${item.id}" class="recall-trigger text-sm text-blue-600 hover:text-blue-800 font-medium">
                                Desafiar Memória
                            </button>
                        </td>
                        <td class="p-3">
                            <button data-id="${item.id}" class="delete-trigger text-red-500 hover:text-red-700 transition">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
                container.insertAdjacentHTML('beforeend', row);
            });

            // Re-adicionar listeners aos botões
            document.querySelectorAll('.recall-trigger').forEach(btn => {
                btn.addEventListener('click', (e) => openRecallModal(e.currentTarget.dataset.id));
            });
            document.querySelectorAll('.delete-trigger').forEach(btn => {
                btn.addEventListener('click', (e) => deleteWord(e.currentTarget.dataset.id));
            });
        }
        
        // --- LÓGICA DO MODAL DE RECALL ---
        
        let activeVocabId = null;

        function openRecallModal(vocabId) {
            const item = vocabData.find(v => v.id === vocabId);
            if (!item) return;

            activeVocabId = vocabId;
            
            document.getElementById('modal-word').textContent = item.word;
            document.getElementById('modal-context').textContent = item.context;

            document.getElementById('answer-area').classList.add('hidden');
            document.getElementById('show-answer-btn').classList.remove('hidden');

            document.getElementById('recall-modal').classList.remove('hidden');
            document.getElementById('recall-modal').classList.add('flex');
        }

        function closeRecallModal() {
            document.getElementById('recall-modal').classList.add('hidden');
            document.getElementById('recall-modal').classList.remove('flex');
            activeVocabId = null;
        }


        // --- INICIALIZAÇÃO E LISTENERS GERAIS ---

        /** Inicializa a aplicação e o Firebase. */
        async function initializeAppAndFirebase() {
            try {
                if (!firebaseConfig) {
                    displayError("As configurações do Firebase (firebaseConfig) não foram fornecidas. O aplicativo não pode salvar dados.");
                    document.getElementById('user-id').textContent = 'SALVAMENTO DESATIVADO';
                    return;
                }

                // 1. Inicializa Firebase
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 2. Configura listener de autenticação (isso dispara o carregamento de dados)
                setupAuthListener();

                // 3. Tenta autenticar
                await attemptAuthentication();

            } catch (error) {
                displayError(`Erro FATAL durante a inicialização: ${error.message}`);
                console.error("Erro na Inicialização:", error);
            }
        }

        // Adicionar Listeners de UI
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndFirebase();
            
            document.getElementById('add-word-btn').addEventListener('click', addWord);
            
            document.getElementById('filter-view').addEventListener('change', (e) => {
                currentFilter = e.target.value;
                renderVocabList();
            });

            // Listeners do Modal
            document.getElementById('close-modal-btn').addEventListener('click', closeRecallModal);
            document.getElementById('show-answer-btn').addEventListener('click', () => {
                document.getElementById('answer-area').classList.remove('hidden');
                document.getElementById('show-answer-btn').classList.add('hidden');
            });

            document.querySelectorAll('.recall-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const level = parseInt(e.target.dataset.level, 10);
                    // Mapeia os níveis de 1, 3, 5 para 1, 2, 3 na SR.
                    // 1: Não Lembrei -> Nível 1 (1 dia)
                    // 3: Dificuldade -> Nível 3 (7 dias)
                    // 5: Fácil/Dominado -> Nível 5 (30 dias)
                    updateWordRetention(activeVocabId, level);
                    closeRecallModal();
                });
            });
        });

    </script>
</body>
</html>
