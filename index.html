<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Mestre de Reten√ß√£o de Vocabul√°rio</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        /* Status Badges */
        .review-status-urgent { background-color: #fee2e2; color: #b91c1c; font-weight: 600; }
        .review-status-due { background-color: #fef3c7; color: #d97706; font-weight: 600; }
        .review-status-mastered { background-color: #d1fae5; color: #059669; font-weight: 600; }
        .review-status-ok { background-color: #dbeafe; color: #2563eb; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 mb-2">Plano Mestre de Reten√ß√£o</h1>
            <p class="text-lg text-gray-600">Engenharia da Mem√≥ria para o Ingl√™s. Adeus, Decoreba!</p>
            <!-- Informa√ß√£o do Usu√°rio -->
            <p class="text-sm text-gray-600 mt-2 font-medium">Seu progresso √© salvo automaticamente neste ID de Usu√°rio (salvo no seu Firestore):</p>
            <p id="user-info" class="text-sm text-blue-500 mt-1 font-bold break-all">Autenticando...</p>
            <p id="auth-status" class="text-xs text-gray-500 mt-1">Verificando status de autentica√ß√£o...</p> <!-- NOVO: Status do Token -->
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center p-8 hidden">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto" style="border-top-color: #2563eb;"></div>
            <p class="text-blue-600">Carregando dados e autenticando...</p>
        </div>

        <!-- Add New Word Form -->
        <div id="input-section" class="card mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Adicionar Vocabul√°rio com Contexto</h2>
            <form id="add-word-form" class="space-y-4">
                <div>
                    <label for="word-input" class="block text-sm font-medium text-gray-700">Palavra/Frase:</label>
                    <input type="text" id="word-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="context-input" class="block text-sm font-medium text-gray-700">Contexto / Frase de Exemplo (Regra do Input Significativo):</label>
                    <textarea id="context-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" rows="2" placeholder="Ex: I found the solution serendipitously during a coffee break."></textarea>
                </div>
                <!-- Mensagem de feedback (sucesso ou erro de duplicidade) -->
                <div id="form-message" class="p-3 rounded-lg text-sm font-medium hidden" role="alert"></div>

                <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150">
                    Adicionar Palavra (In√≠cio da Repeti√ß√£o Espa√ßada)
                </button>
            </form>
        </div>

        <!-- Mastery Tracker Table -->
        <div id="tracker-section" class="card overflow-x-auto">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Monitoramento de Reten√ß√£o (Spaced Repetition)</h2>
            <p class="text-sm text-gray-500 mb-4">Seu vocabul√°rio, classificado por urg√™ncia de revis√£o.</p>
            
            <!-- Filter Controls -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-3 sm:space-y-0">
                <p class="text-md font-medium text-gray-700">Filtro de Visualiza√ß√£o:</p>
                <div id="filter-controls" class="flex flex-wrap gap-2">
                    <!-- Buttons are styled and managed by JS in applyFilterAndRender -->
                    <button data-filter="all" class="filter-btn px-4 py-1 text-sm rounded-lg font-semibold text-white shadow-md transition duration-150"></button>
                    <button data-filter="due" class="filter-btn px-4 py-1 text-sm rounded-lg font-semibold text-white shadow-md transition duration-150"></button>
                    <button data-filter="mastered" class="filter-btn px-4 py-1 text-sm rounded-lg font-semibold text-white shadow-md transition duration-150"></button>
                </div>
            </div>
            
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Palavra</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√≥xima Revis√£o</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Encoding (Multisensorial)</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Desafio (Recall)</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="word-list" class="bg-white divide-y divide-gray-200">
                    <!-- Word rows will be dynamically inserted here -->
                </tbody>
            </table>

            <div id="empty-state" class="text-center p-8 text-gray-500 hidden">
                Nenhuma palavra cadastrada ainda. Adicione uma nova palavra acima!
            </div>
        </div>

        <!-- CONTEXT MODAL for Retrieval Practice (Updated with Difficulty Buttons) -->
        <div id="context-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white card max-w-lg w-full">
                <h3 class="text-xl font-bold mb-4 text-blue-700">Pr√°tica de Recupera√ß√£o Ativa (Retrieval Practice)</h3>
                <p class="text-gray-700 mb-4">Lembre-se do significado e do contexto desta palavra:</p>
                
                <!-- Palavra Desafiada -->
                <div class="p-4 bg-gray-100 rounded-t-md">
                    <p class="text-2xl font-extrabold text-gray-900" id="modal-word"></p>
                </div>
                
                <!-- Input do Usu√°rio (Active Recall) -->
                <div id="modal-recall-input-container" class="p-4 pt-2 border-x border-b rounded-b-md mb-4">
                    <label for="user-answer-input" class="block text-sm font-semibold text-gray-700 mb-2">Sua Resposta (Tente escrever o contexto):</label>
                    <textarea id="user-answer-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2 border" rows="3" placeholder="Digite aqui o que voc√™ lembra sobre o significado e uso desta palavra."></textarea>
                </div>

                <!-- Contexto Oculto / Resposta Correta -->
                <div id="modal-hidden-context" class="mt-2 p-4 bg-yellow-50 rounded-md border border-yellow-200 hidden mb-4">
                    <p class="text-sm font-semibold text-gray-700">Resposta Correta / Contexto:</p>
                    <p id="modal-context" class="text-base italic text-gray-800 mt-1"></p>
                </div>

                <!-- Bot√µes de A√ß√£o (Com base no estado do Recall) -->
                <div id="modal-action-buttons">
                    <button id="reveal-answer-btn" class="w-full px-4 py-2 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600 mb-2 transition duration-150">
                        Revelar Resposta e Comparar
                    </button>
                    <!-- Bot√µes de Dificuldade (Hidden by default) -->
                    <div id="difficulty-buttons" class="hidden flex justify-between space-x-2 mt-4">
                        <button data-difficulty="hard" class="review-btn w-1/2 px-4 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                            N√£o Lembrei (Dif√≠cil)
                        </button>
                        <button data-difficulty="easy" class="review-btn w-1/2 px-4 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                            Lembrei (F√°cil)
                        </button>
                    </div>

                    <button id="close-modal-btn" class="w-full px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 mt-2 transition duration-150">
                        Fechar Modal
                    </button>
                </div>
            </div>
        </div>
        
        <!-- EDIT WORD MODAL (NOVO) -->
        <div id="edit-word-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white card max-w-lg w-full">
                <h3 class="text-xl font-bold mb-4 text-orange-600">Editar Vocabul√°rio</h3>
                <form id="edit-word-form" class="space-y-4">
                    <input type="hidden" id="edit-word-id">
                    <div>
                        <label for="edit-word-input" class="block text-sm font-medium text-gray-700">Palavra/Frase:</label>
                        <input type="text" id="edit-word-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 p-2 border">
                    </div>
                    <div>
                        <label for="edit-context-input" class="block text-sm font-medium text-gray-700">Contexto / Frase de Exemplo:</label>
                        <textarea id="edit-context-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 p-2 border" rows="3"></textarea>
                    </div>
                    
                    <div id="edit-form-message" class="p-3 rounded-lg text-sm font-medium hidden" role="alert"></div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-150">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg shadow-md hover:bg-orange-700 transition duration-150">
                            Salvar Altera√ß√µes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- DELETE CONFIRMATION MODAL -->
        <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white card max-w-sm w-full">
                <h3 class="text-xl font-bold mb-4 text-red-600">Confirma√ß√£o de Exclus√£o</h3>
                <p class="text-gray-700 mb-6">Tem certeza que deseja deletar permanentemente a palavra <span id="word-to-delete" class="font-bold"></span>?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-150">
                        Cancelar
                    </button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">
                        Deletar
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Firebase Imports and Script -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ==============================================================================
        // CONFIGURA√á√ïES DO FIREBASE
        // ==============================================================================

        // 1. Configura√ß√£o do Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // Vari√°veis do Ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // ESTADO GLOBAL DO APLICATIVO
        let allWords = []; 
        let currentFilter = 'all'; 
        let currentReviewWord = null; // Para rastrear a palavra no modal de desafio

        // 2. Caminho da Cole√ß√£o: Usando o CAMINHO COMPLETO E OBRIGAT√ìRIO do Canvas
        const getWordCollectionPath = () => `artifacts/${appId}/users/${userId}/mastery_tracker`;

        // ==============================================================================
        // L√ìGICA DE REPETI√á√ÉO ESPA√áADA
        // ==============================================================================

        // Defines the interval in days for the next review based on the current review number (0-indexed)
        const REPETITION_SCHEDULE = [1, 2, 4, 7, 30]; // Intervalos em dias

        // --- Utility Functions ---
        
        /**
         * Mostra uma mensagem de feedback tempor√°ria no formul√°rio.
         */
        function showFormMessage(message, isError = false, elementId = 'form-message') {
            const msgEl = document.getElementById(elementId);
            msgEl.textContent = message;
            msgEl.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-orange-800');
            
            if (isError) {
                msgEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                msgEl.classList.add('bg-green-100', 'text-green-800');
            }

            setTimeout(() => {
                msgEl.classList.add('hidden');
            }, 4000);
        }

        function calculateNextReviewDay(currentReviewIndex) {
            if (currentReviewIndex >= REPETITION_SCHEDULE.length) {
                return null; // Mastered
            }
            return REPETITION_SCHEDULE[currentReviewIndex];
        }

        function isReviewDue(lastReviewDate, nextReviewDay) {
            if (nextReviewDay === null) return false;
            if (!lastReviewDate) return true; // Should review if no previous review date

            const today = new Date();
            const lastReview = new Date(lastReviewDate);
            const dueTime = lastReview.getTime() + (nextReviewDay * 24 * 60 * 60 * 1000);
            return dueTime <= today.getTime();
        }

        function formatNextReview(word) {
            if (word.isMastered) {
                return `<span class="review-status-mastered px-2 py-1 rounded-full text-xs">Dominado (${word.reviewCount}x)</span>`;
            }

            const nextReviewDay = word.nextReviewDay;
            const lastReviewDate = word.lastReviewDate ? new Date(word.lastReviewDate) : null;

            if (isReviewDue(lastReviewDate, nextReviewDay)) {
                return `<span class="review-status-urgent px-2 py-1 rounded-full text-xs animate-pulse">REVIS√ÉO HOJE!</span>`;
            }

            // Calculate days remaining (or if due in the future)
            if (lastReviewDate) {
                const dueDate = new Date(lastReviewDate.getTime() + (nextReviewDay * 24 * 60 * 60 * 1000));
                const timeDiff = dueDate.getTime() - new Date().getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                if (daysDiff > 0) {
                     return `<span class="review-status-ok px-2 py-1 rounded-full text-xs">Pr√≥xima em ${daysDiff} dias</span>`;
                } else {
                     // Caso em que j√° passou o dia de revis√£o (negativo ou zero)
                     return `<span class="review-status-urgent px-2 py-1 rounded-full text-xs">REVIS√ÉO PENDENTE!</span>`;
                }
            }
            // Caso de palavra rec√©m-adicionada (sem lastReviewDate)
            return `<span class="review-status-due px-2 py-1 rounded-full text-xs">Nova, Revisar Hoje</span>`;
        }


        // --- Firestore Operations ---

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // NOVO: Exibe o status inicial do token
                const authStatusEl = document.getElementById('auth-status');
                if (initialAuthToken) {
                    authStatusEl.textContent = 'Status: Token Recebido (Autentica√ß√£o Customizada)';
                } else {
                    authStatusEl.textContent = 'Status: Token Ausente (Tentando Login An√¥nimo)';
                    authStatusEl.classList.add('text-red-500'); // Destaca se n√£o houver token
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                setLogLevel('debug');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-info').textContent = userId;
                        // Atualiza o status ap√≥s o login
                        authStatusEl.textContent = `Login: ${initialAuthToken ? 'Customizado' : 'An√¥nimo'} | UID: ${userId.substring(0, 10)}...`;
                        authStatusEl.classList.remove('text-red-500');
                        authStatusEl.classList.add('text-green-600');
                        startListeningForWords();
                        document.getElementById('loading').classList.add('hidden');
                        console.log("Autentica√ß√£o e Listener do Firebase iniciados com sucesso.");
                    } else {
                        document.getElementById('user-info').textContent = 'Erro de Autentica√ß√£o.';
                        authStatusEl.textContent = 'Erro: Falha no Login (Verifique Regras)';
                        authStatusEl.classList.remove('text-green-600');
                        authStatusEl.classList.add('text-red-600');
                    }
                });

            } catch (error) {
                console.error("Erro FATAL na inicializa√ß√£o ou autentica√ß√£o do Firebase:", error);
                document.getElementById('loading').innerHTML = '<p class="text-red-600">Erro FATAL ao carregar (verifique o console para detalhes).</p>';
            }
        }

        /**
         * Adds a new word to the tracker.
         */
        async function addWord(word, context) {
            if (!isAuthReady) {
                showFormMessage("Erro de autentica√ß√£o. Tente recarregar a p√°gina.", true);
                return;
            }

            const normalizedWord = word.trim().toLowerCase();
            
            const isDuplicate = allWords.some(item => item.word.toLowerCase() === normalizedWord);
            if (isDuplicate) {
                showFormMessage(`A palavra "${word.trim()}" j√° est√° na sua lista!`, true);
                return;
            }

            const newWord = {
                word: word.trim(),
                context: context.trim(),
                reviewCount: 0,
                nextReviewDay: REPETITION_SCHEDULE[0], // Start with 1 day interval
                lastReviewDate: null,
                isMastered: false,
                seen: false,
                heard: false,
                said: false,
                written: false,
                createdAt: serverTimestamp(),
                userId: userId
            };

            try {
                const wordsCollection = collection(db, getWordCollectionPath());
                await addDoc(wordsCollection, newWord);
                showFormMessage("Palavra adicionada com sucesso!", false);
            } catch (error) {
                console.error("Erro ao adicionar palavra:", error);
                showFormMessage("Erro ao salvar palavra. Tente novamente.", true);
            }
        }

        /**
         * Updates a word's spaced repetition status based on difficulty.
         */
        async function completeReview(wordId, currentReviewCount, difficulty) {
            if (!isAuthReady) return;

            let nextReviewCount;

            if (difficulty === 'easy') {
                // Se foi f√°cil, avan√ßa para o pr√≥ximo est√°gio
                nextReviewCount = currentReviewCount + 1;
            } else { 
                // Se foi dif√≠cil, N√ÉO avan√ßa (mant√©m o count atual), for√ßando a repeti√ß√£o do mesmo intervalo curto.
                nextReviewCount = currentReviewCount; 
            }

            const nextReviewInterval = calculateNextReviewDay(nextReviewCount);
            const isMastered = nextReviewInterval === null;

            const updates = {
                reviewCount: nextReviewCount,
                lastReviewDate: new Date().toISOString(),
                nextReviewDay: nextReviewInterval,
                isMastered: isMastered
            };

            try {
                const wordRef = doc(db, getWordCollectionPath(), wordId);
                await updateDoc(wordRef, updates);
                console.log(`Revis√£o de ${wordId} completada. Dificuldade: ${difficulty}. Pr√≥xima em ${nextReviewInterval} dias.`);
            } catch (error) {
                console.error("Erro ao completar revis√£o:", error);
            }
        }
        
        /**
         * Updates the word and context of an existing word. (NOVO)
         */
        async function updateWord(wordId, newWord, newContext) {
             if (!isAuthReady) {
                showFormMessage("Erro de autentica√ß√£o.", true, 'edit-form-message');
                return;
            }
            
            const updates = {
                word: newWord.trim(),
                context: newContext.trim()
            };

            try {
                const wordRef = doc(db, getWordCollectionPath(), wordId);
                await updateDoc(wordRef, updates);
                showFormMessage("Palavra atualizada com sucesso!", false, 'edit-form-message');
            } catch (error) {
                console.error("Erro ao atualizar palavra:", error);
                showFormMessage("Erro ao salvar altera√ß√µes. Tente novamente.", true, 'edit-form-message');
            }
        }

        /**
         * Updates the multisensory encoding status.
         */
        async function updateEncoding(wordId, field, value) {
            if (!isAuthReady) return;
            const updates = { [field]: value };
            try {
                const wordRef = doc(db, getWordCollectionPath(), wordId);
                await updateDoc(wordRef, updates);
            } catch (error) {
                console.error(`Erro ao atualizar encoding ${field}:`, error);
            }
        }

        /**
         * Shows the custom confirmation modal for deleting a word.
         */
        let wordToDeleteInfo = null;
        function showDeleteConfirmation(wordId, wordText) {
            wordToDeleteInfo = { id: wordId, text: wordText };
            document.getElementById('word-to-delete').textContent = wordText;
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        }

        /**
         * Executes the deletion of the word.
         */
        async function executeDeleteWord() {
            if (!isAuthReady || !wordToDeleteInfo) return;
            
            const wordId = wordToDeleteInfo.id;

            try {
                const wordRef = doc(db, getWordCollectionPath(), wordId);
                await deleteDoc(wordRef);
            } catch (error) {
                console.error("Erro ao deletar palavra:", error);
            } finally {
                document.getElementById('delete-confirm-modal').classList.add('hidden');
                wordToDeleteInfo = null;
            }
        }
        
        /**
         * Abre o modal de edi√ß√£o e preenche com os dados da palavra (NOVO).
         */
        function openEditModal(word) {
            document.getElementById('edit-word-id').value = word.id;
            document.getElementById('edit-word-input').value = word.word;
            document.getElementById('edit-context-input').value = word.context;
            document.getElementById('edit-form-message').classList.add('hidden');
            document.getElementById('edit-word-modal').classList.remove('hidden');
        }


        /**
         * Listens for real-time updates to the word list and updates the local state.
         */
        function startListeningForWords() {
            if (!isAuthReady || !userId) {
                console.error("Listener do Firestore tentado antes de o ID do usu√°rio estar definido.");
                return;
            }

            const wordsCollection = collection(db, getWordCollectionPath());
            const q = query(wordsCollection);

            onSnapshot(q, (snapshot) => {
                allWords = []; // Atualiza o estado global
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Garante que os dados necess√°rios para o JS est√£o presentes
                    allWords.push({ 
                        id: doc.id, 
                        ...data,
                        reviewCount: data.reviewCount || 0,
                        nextReviewDay: data.nextReviewDay || REPETITION_SCHEDULE[0],
                        isMastered: data.isMastered || false
                    });
                });
                
                // Renderiza a lista aplicando o filtro atual
                applyFilterAndRender(); 
                
            }, (error) => {
                console.error("Erro ao ouvir updates do Firestore:", error);
                // ESTE √â O ERRO CR√çTICO A SER MONITORADO
                if (error.code === 'permission-denied') {
                    console.error("üö® ERRO CR√çTICO: PERMISS√ÉO NEGADA (RULES). As regras do Firestore n√£o permitem este acesso.");
                    document.getElementById('loading').innerHTML = '<p class="text-red-600 font-bold">ERRO: Permiss√£o Negada. Por favor, verifique as Regras de Seguran√ßa do Firestore e recarregue.</p>';
                } else {
                    document.getElementById('loading').innerHTML = `<p class="text-red-600">Erro de Conex√£o: ${error.code}</p>`;
                }
            });
        }
        
        /**
         * Aplica o filtro atual e gerencia os estilos dos bot√µes.
         */
        function applyFilterAndRender(filter = currentFilter) {
            currentFilter = filter;
            
            // 1. Atualiza o estilo e o texto dos bot√µes
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const filterType = btn.dataset.filter;
                btn.classList.remove('bg-gray-700', 'bg-blue-600', 'hover:bg-blue-700', 'bg-yellow-500', 'hover:bg-yellow-600', 'bg-green-500', 'hover:bg-green-600');
                btn.classList.add('text-white');
                
                if (filterType === 'all') {
                    btn.textContent = 'Todas';
                    if (filter === 'all') {
                        btn.classList.add('bg-gray-700'); 
                    } else {
                        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                } else if (filterType === 'due') {
                    const dueCount = allWords.filter(word => isReviewDue(word.lastReviewDate, word.nextReviewDay)).length;
                    btn.textContent = `Revisar Hoje (${dueCount})`;
                    if (filter === 'due') {
                        btn.classList.add('bg-gray-700');
                    } else {
                        btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    }
                } else if (filterType === 'mastered') {
                    btn.textContent = 'Dominadas';
                    if (filter === 'mastered') {
                        btn.classList.add('bg-gray-700');
                    } else {
                        btn.classList.add('bg-green-500', 'hover:bg-green-600');
                    }
                }
            });
            
            // 2. Renderiza a lista filtrada
            renderWordList(allWords);
        }

        /**
         * Renders the list of words in the table.
         */
        function renderWordList(words) {
            const wordListBody = document.getElementById('word-list');
            wordListBody.innerHTML = ''; 

            const filteredWords = words.filter(word => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'mastered') return word.isMastered;
                if (currentFilter === 'due') {
                    return isReviewDue(word.lastReviewDate, word.nextReviewDay);
                }
                return true;
            });

            const sortedWords = filteredWords.sort((a, b) => {
                const aDue = isReviewDue(a.lastReviewDate, a.nextReviewDay);
                const bDue = isReviewDue(b.lastReviewDate, b.nextReviewDay);

                if (a.isMastered !== b.isMastered) return a.isMastered ? 1 : -1;
                if (aDue !== bDue) return aDue ? -1 : 1;
                if (a.nextReviewDay !== b.nextReviewDay) return a.nextReviewDay - b.nextReviewDay;
                return 0;
            });

            if (sortedWords.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            sortedWords.forEach(word => {
                const row = wordListBody.insertRow();
                row.className = 'hover:bg-gray-50';

                // 1. Word Column
                row.insertCell().innerHTML = `<span class="font-bold text-gray-900">${word.word}</span>`;

                // 2. Next Review Column (Spaced Repetition Status)
                row.insertCell().innerHTML = formatNextReview(word);

                // 3. Multisensory Encoding
                const encodingCell = row.insertCell();
                encodingCell.className = 'px-2 py-4 whitespace-nowrap text-sm text-gray-500';
                encodingCell.innerHTML = `
                    <div class="flex flex-wrap gap-2 text-xs">
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-field="seen" ${word.seen ? 'checked' : ''} class="encoding-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-id="${word.id}">
                            <span class="ml-1">Vi</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-field="heard" ${word.heard ? 'checked' : ''} class="encoding-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-id="${word.id}">
                            <span class="ml-1">Ouvi</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-field="said" ${word.said ? 'checked' : ''} class="encoding-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-id="${word.id}">
                            <span class="ml-1">Falei</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-field="written" ${word.written ? 'checked' : ''} class="encoding-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-id="${word.id}">
                            <span class="ml-1">Escrevi</span>
                        </label>
                    </div>
                `;

                // 4. Retrieval Practice (Challenge Button)
                const challengeCell = row.insertCell();
                challengeCell.className = 'px-2 py-4 whitespace-nowrap text-sm';
                challengeCell.innerHTML = `
                    <button data-word-id="${word.id}" 
                            data-review-count="${word.reviewCount}"
                            data-word="${word.word}" 
                            data-context="${word.context}"
                        class="recall-btn px-3 py-1 bg-teal-500 text-white text-xs font-semibold rounded-full hover:bg-teal-600 transition duration-150">
                        Desafiar Mem√≥ria
                    </button>
                `;

                // 5. Actions (Edit, Delete)
                const actionsCell = row.insertCell();
                actionsCell.className = 'px-2 py-4 whitespace-nowrap text-sm font-medium';
                actionsCell.innerHTML = `
                    <button data-word-id="${word.id}" 
                            data-word-text="${word.word}" 
                            data-context-text="${word.context}"
                            class="edit-btn text-orange-600 hover:text-orange-900 font-semibold mr-2 transition duration-150">
                            Editar
                    </button>
                    <button onclick="window.showDeleteConfirmation('${word.id}', '${word.word}')"
                        class="text-red-600 hover:text-red-900 transition duration-150">
                        Deletar
                    </button>
                `;
            });

            attachEventListeners();
        }

        // --- Event Listeners and UI Logic ---

        function attachEventListeners() {
            // Form submission for adding new words
            document.getElementById('add-word-form').onsubmit = (e) => {
                e.preventDefault();
                const word = document.getElementById('word-input').value;
                const context = document.getElementById('context-input').value;

                if (word && context) {
                    addWord(word, context);
                    document.getElementById('add-word-form').reset();
                } else {
                    showFormMessage('Erro: Por favor, preencha a palavra E o contexto.', true);
                }
            };

            // Encoding Checkbox handling
            document.querySelectorAll('.encoding-checkbox').forEach(checkbox => {
                checkbox.onchange = (e) => {
                    const id = e.target.dataset.id;
                    const field = e.target.dataset.field;
                    const checked = e.target.checked;
                    updateEncoding(id, field, checked);
                };
            });

            // Filter Controls handling
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = (e) => applyFilterAndRender(e.target.dataset.filter);
            });
            
            // EDIT Modal Event Listener (NOVO)
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = (e) => {
                    // Busca a palavra inteira no estado global 'allWords'
                    const word = allWords.find(w => w.id === e.target.dataset.wordId);
                    if (word) {
                        openEditModal(word);
                    }
                };
            });
            
            document.getElementById('cancel-edit-btn').onclick = () => {
                document.getElementById('edit-word-modal').classList.add('hidden');
            };
            
            document.getElementById('edit-word-form').onsubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-word-id').value;
                const newWord = document.getElementById('edit-word-input').value;
                const newContext = document.getElementById('edit-context-input').value;
                
                updateWord(id, newWord, newContext);
                // Fecha o modal ap√≥s um pequeno delay para a mensagem de sucesso
                setTimeout(() => {
                    document.getElementById('edit-word-modal').classList.add('hidden');
                }, 1000);
            };

            // Delete Confirmation Modal Listeners
            document.getElementById('confirm-delete-btn').onclick = executeDeleteWord;
            document.getElementById('cancel-delete-btn').onclick = () => {
                document.getElementById('delete-confirm-modal').classList.add('hidden');
                wordToDeleteInfo = null;
            };


            // Retrieval Practice Modal handling
            const modal = document.getElementById('context-modal');
            const modalWordEl = document.getElementById('modal-word');
            const modalContextEl = document.getElementById('modal-context');
            const hiddenContextEl = document.getElementById('modal-hidden-context');
            const revealAnswerBtn = document.getElementById('reveal-answer-btn'); 
            const userAnswerInput = document.getElementById('user-answer-input'); 
            const difficultyButtons = document.getElementById('difficulty-buttons');
            const closeModalBtn = document.getElementById('close-modal-btn');
            
            
            document.querySelectorAll('.recall-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const wordId = e.target.dataset.wordId;
                    const wordText = e.target.dataset.word;
                    const contextText = e.target.dataset.context;
                    const reviewCount = parseInt(e.target.dataset.reviewCount);

                    // 1. Armazena o estado da palavra atual
                    currentReviewWord = { id: wordId, reviewCount: reviewCount };
                    
                    // 2. Preenche e Reseta o Modal
                    modalWordEl.textContent = wordText;
                    modalContextEl.textContent = contextText;
                    userAnswerInput.value = ''; 
                    hiddenContextEl.classList.add('hidden'); 
                    revealAnswerBtn.classList.remove('hidden'); // Mostra o bot√£o de revelar
                    difficultyButtons.classList.add('hidden'); // Esconde os bot√µes de dificuldade
                    
                    modal.classList.remove('hidden');

                    // 3. A√ß√£o: Revelar Resposta
                    revealAnswerBtn.onclick = () => {
                        hiddenContextEl.classList.remove('hidden');
                        revealAnswerBtn.classList.add('hidden'); // Esconde o bot√£o de revelar
                        difficultyButtons.classList.remove('hidden'); // Mostra os bot√µes de dificuldade
                    };
                };
            });

            // A√ß√£o: Bot√µes de Dificuldade
            document.querySelectorAll('.review-btn').forEach(btn => {
                btn.onclick = (e) => {
                    if (!currentReviewWord) return;
                    
                    const difficulty = e.target.dataset.difficulty; // 'easy' or 'hard'
                    const { id, reviewCount } = currentReviewWord;

                    // Chama a fun√ß√£o de revis√£o com a dificuldade
                    completeReview(id, reviewCount, difficulty);
                    
                    // Limpa o estado e fecha o modal
                    currentReviewWord = null;
                    modal.classList.add('hidden');
                };
            });

            // A√ß√£o: Fechar Modal
            closeModalBtn.onclick = () => {
                // Se o modal for fechado sem clicar em "Lembrei/N√£o Lembrei", 
                // a revis√£o n√£o √© marcada como completa.
                currentReviewWord = null;
                modal.classList.add('hidden');
            };
        }

        // Expose functions to window scope for onclick attributes in dynamic HTML
        window.showDeleteConfirmation = showDeleteConfirmation;

        // Start the application
        document.getElementById('loading').classList.remove('hidden');
        initializeFirebase();

    </script>
</body>
</html>
