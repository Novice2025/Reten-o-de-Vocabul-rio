<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Mestre de Reten√ß√£o de Vocabul√°rio</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        /* Status Badges */
        .review-status-urgent { background-color: #fee2e2; color: #b91c1c; font-weight: 600; }
        .review-status-due { background-color: #fef3c7; color: #d97706; font-weight: 600; }
        .review-status-mastered { background-color: #d1fae5; color: #059669; font-weight: 600; }
        .review-status-ok { background-color: #dbeafe; color: #2563eb; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 mb-2">Plano Mestre de Reten√ß√£o</h1>
            <p class="text-lg text-gray-600">Engenharia da Mem√≥ria para o Ingl√™s. Adeus, Decoreba!</p>
            <!-- Alterado: Melhorando a informa√ß√£o do usu√°rio -->
            <p class="text-sm text-gray-600 mt-2 font-medium">Seu progresso √© salvo automaticamente neste ID de Usu√°rio (salvo no seu Firestore):</p>
            <p id="user-info" class="text-sm text-blue-500 mt-1 font-bold break-all">Autenticando...</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center p-8 hidden">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto" style="border-top-color: #2563eb;"></div>
            <p class="text-blue-600">Carregando dados e autenticando...</p>
        </div>

        <!-- Add New Word Form -->
        <div id="input-section" class="card mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Adicionar Vocabul√°rio com Contexto</h2>
            <form id="add-word-form" class="space-y-4">
                <div>
                    <label for="word-input" class="block text-sm font-medium text-gray-700">Palavra/Frase:</label>
                    <input type="text" id="word-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                </div>
                <div>
                    <label for="context-input" class="block text-sm font-medium text-gray-700">Contexto / Frase de Exemplo (Regra do Input Significativo):</label>
                    <textarea id="context-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" rows="2" placeholder="Ex: I found the solution serendipitously during a coffee break."></textarea>
                </div>
                <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150">
                    Adicionar Palavra (In√≠cio da Repeti√ß√£o Espa√ßada)
                </button>
            </form>
        </div>

        <!-- Mastery Tracker Table -->
        <div id="tracker-section" class="card overflow-x-auto">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Monitoramento de Reten√ß√£o (Spaced Repetition)</h2>
            <p class="text-sm text-gray-500 mb-4">Seu vocabul√°rio, classificado por urg√™ncia de revis√£o.</p>
            
            <!-- NOVO: Filter Controls -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-3 sm:space-y-0">
                <p class="text-md font-medium text-gray-700">Filtro de Visualiza√ß√£o:</p>
                <div id="filter-controls" class="flex flex-wrap gap-2">
                    <!-- 'all' button is active by default (bg-gray-700) -->
                    <button data-filter="all" class="filter-btn px-4 py-1 text-sm rounded-lg font-semibold bg-gray-700 text-white shadow-md transition duration-150">Todas</button>
                    <button data-filter="due" class="filter-btn px-4 py-1 text-sm rounded-lg font-semibold bg-yellow-500 text-white shadow-md hover:bg-yellow-600 transition duration-150">Revisar Hoje</button>
                    <button data-filter="mastered" class="filter-btn px-4 py-1 text-sm rounded-lg font-semibold bg-green-500 text-white shadow-md hover:bg-green-600 transition duration-150">Dominadas</button>
                </div>
            </div>
            <!-- Fim do NOVO Filter Controls -->
            
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Palavra</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√≥xima Revis√£o</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Encoding (Multisensorial)</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Desafio (Recall)</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="word-list" class="bg-white divide-y divide-gray-200">
                    <!-- Word rows will be dynamically inserted here -->
                </tbody>
            </table>

            <div id="empty-state" class="text-center p-8 text-gray-500 hidden">
                Nenhuma palavra cadastrada ainda. Adicione uma nova palavra acima!
            </div>
        </div>

        <!-- Context Modal for Retrieval Practice -->
        <div id="context-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white card max-w-lg w-full">
                <h3 class="text-xl font-bold mb-4 text-blue-700">Pr√°tica de Recupera√ß√£o Ativa (Retrieval Practice)</h3>
                <p class="text-gray-700 mb-4">Lembre-se do significado e do contexto desta palavra:</p>
                <div class="p-4 bg-gray-100 rounded-md mb-4">
                    <p class="text-2xl font-extrabold text-gray-900" id="modal-word"></p>
                    <div id="modal-hidden-context" class="mt-2 p-2 bg-yellow-50 rounded-md border border-yellow-200 hidden">
                        <p class="text-sm font-semibold text-gray-700">Contexto:</p>
                        <p id="modal-context" class="text-base italic text-gray-800"></p>
                    </div>
                </div>

                <button id="show-context-btn" class="w-full px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 mb-2">
                    Mostrar Contexto / Confirmar Resposta
                </button>
                <button id="close-modal-btn" class="w-full px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400">
                    Fechar
                </button>
            </div>
        </div>
        
        <!-- DELETE CONFIRMATION MODAL -->
        <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white card max-w-sm w-full">
                <h3 class="text-xl font-bold mb-4 text-red-600">Confirma√ß√£o de Exclus√£o</h3>
                <p class="text-gray-700 mb-6">Tem certeza que deseja deletar permanentemente a palavra <span id="word-to-delete" class="font-bold"></span>?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-150">
                        Cancelar
                    </button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">
                        Deletar
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Firebase Imports and Script -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ==============================================================================
        // CONFIGURA√á√ïES DO FIREBASE
        // ==============================================================================

        // 1. Configura√ß√£o do Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // Vari√°veis do Ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // ESTADO GLOBAL DO APLICATIVO (NOVO)
        let allWords = []; // Armazena a lista completa de palavras do Firestore
        let currentFilter = 'all'; // 'all', 'due', 'mastered'

        // 2. Caminho da Cole√ß√£o: Usando o CAMINHO COMPLETO E OBRIGAT√ìRIO do Canvas
        const getWordCollectionPath = () => `artifacts/${appId}/users/${userId}/mastery_tracker`;

        // ==============================================================================
        // FIM DAS ALTERA√á√ïES DE SETUP
        // ==============================================================================

        // --- Spaced Repetition Logic ---
        // Defines the interval in days for the next review based on the current review number (0-indexed)
        const REPETITION_SCHEDULE = [1, 2, 4, 7, 30];

        // --- Utility Functions ---
        function calculateNextReviewDay(currentReviewIndex) {
            if (currentReviewIndex >= REPETITION_SCHEDULE.length) {
                return null; // Mastered
            }
            return REPETITION_SCHEDULE[currentReviewIndex];
        }

        function isReviewDue(lastReviewDate, nextReviewDay) {
            if (nextReviewDay === null) return false;
            if (!lastReviewDate) return true; // Should review if no previous review date

            const today = new Date();
            const lastReview = new Date(lastReviewDate);
            const dueTime = lastReview.getTime() + (nextReviewDay * 24 * 60 * 60 * 1000);
            return dueTime <= today.getTime();
        }

        function formatNextReview(word) {
            if (word.isMastered) {
                return `<span class="review-status-mastered px-2 py-1 rounded-full text-xs">Dominado (${word.reviewCount}x)</span>`;
            }

            const nextReviewDay = word.nextReviewDay;
            const lastReviewDate = word.lastReviewDate ? new Date(word.lastReviewDate) : null;

            if (isReviewDue(lastReviewDate, nextReviewDay)) {
                return `<span class="review-status-urgent px-2 py-1 rounded-full text-xs">REVIS√ÉO HOJE!</span>`;
            }

            // Calculate days remaining (or if due in the future)
            if (lastReviewDate) {
                const dueDate = new Date(lastReviewDate.getTime() + (nextReviewDay * 24 * 60 * 60 * 1000));
                const timeDiff = dueDate.getTime() - new Date().getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                if (daysDiff > 0) {
                     return `<span class="review-status-ok px-2 py-1 rounded-full text-xs">Revisar em ${daysDiff} dias</span>`;
                } else {
                     // Caso em que j√° passou o dia de revis√£o (negativo ou zero)
                     return `<span class="review-status-urgent px-2 py-1 rounded-full text-xs">REVIS√ÉO PENDENTE!</span>`;
                }
            }
            return `<span class="review-status-ok px-2 py-1 rounded-full text-xs">Pr√≥xima em ${nextReviewDay} dias</span>`;
        }


        // --- Firestore Operations ---

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            
            try {
                // 1. Inicializa o App
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // setLogLevel agora est√° importado corretamente
                setLogLevel('debug');

                // 2. Autentica√ß√£o: Usar o token personalizado se existir, caso contr√°rio, usar an√≥nimo.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Listener do Estado de Autentica√ß√£o
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        // Mostrar o ID do usu√°rio completo.
                        document.getElementById('user-info').textContent = userId;
                        startListeningForWords();
                        document.getElementById('loading').classList.add('hidden');
                        console.log("Autentica√ß√£o e Listener do Firebase iniciados com sucesso.");
                    } else {
                        document.getElementById('user-info').textContent = 'Erro de Autentica√ß√£o. Tente recarregar.';
                    }
                });

            } catch (error) {
                console.error("Erro FATAL na inicializa√ß√£o ou autentica√ß√£o do Firebase:", error);
                document.getElementById('loading').innerHTML = '<p class="text-red-600">Erro FATAL ao carregar (verifique o console para detalhes).</p>';
            }
        }

        /**
         * Adds a new word to the tracker.
         */
        async function addWord(word, context) {
            if (!isAuthReady) {
                console.error("Authentication not ready.");
                return;
            }

            const newWord = {
                word: word.trim(),
                context: context.trim(),
                reviewCount: 0,
                nextReviewDay: REPETITION_SCHEDULE[0], // Start with 1 day interval
                lastReviewDate: null,
                isMastered: false,
                seen: false,
                heard: false,
                said: false,
                written: false,
                createdAt: serverTimestamp(),
                userId: userId
            };

            try {
                const wordsCollection = collection(db, getWordCollectionPath());
                await addDoc(wordsCollection, newWord);
                console.log("Palavra adicionada com sucesso!");
            } catch (error) {
                console.error("Erro ao adicionar palavra:", error);
                console.error("Erro ao salvar palavra. Tente novamente.");
            }
        }

        /**
         * Updates a word's spaced repetition status.
         */
        async function completeReview(wordId, currentReviewCount) {
            if (!isAuthReady) return;

            const nextReviewCount = currentReviewCount + 1;
            const nextReviewInterval = calculateNextReviewDay(nextReviewCount);
            const isMastered = nextReviewInterval === null;

            const updates = {
                reviewCount: nextReviewCount,
                lastReviewDate: new Date().toISOString(),
                nextReviewDay: nextReviewInterval,
                isMastered: isMastered
            };

            try {
                const wordRef = doc(db, getWordCollectionPath(), wordId);
                await updateDoc(wordRef, updates);
                console.log(`Revis√£o de ${wordId} completada. Pr√≥xima em ${nextReviewInterval} dias.`);
            } catch (error) {
                console.error("Erro ao completar revis√£o:", error);
            }
        }

        /**
         * Updates the multisensory encoding status.
         */
        async function updateEncoding(wordId, field, value) {
            if (!isAuthReady) return;
            const updates = { [field]: value };
            try {
                const wordRef = doc(db, getWordCollectionPath(), wordId);
                await updateDoc(wordRef, updates);
            } catch (error) {
                console.error(`Erro ao atualizar encoding ${field}:`, error);
            }
        }

        /**
         * Shows the custom confirmation modal for deleting a word.
         */
        let wordToDeleteInfo = null;
        function showDeleteConfirmation(wordId, wordText) {
            wordToDeleteInfo = { id: wordId, text: wordText };
            document.getElementById('word-to-delete').textContent = wordText;
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        }

        /**
         * Executes the deletion of the word.
         */
        async function executeDeleteWord() {
            if (!isAuthReady || !wordToDeleteInfo) return;
            
            const wordId = wordToDeleteInfo.id;

            try {
                const wordRef = doc(db, getWordCollectionPath(), wordId);
                await deleteDoc(wordRef);
                console.log(`Palavra ${wordId} deletada.`);
            } catch (error) {
                console.error("Erro ao deletar palavra:", error);
            } finally {
                // Fechar o modal
                document.getElementById('delete-confirm-modal').classList.add('hidden');
                wordToDeleteInfo = null;
            }
        }
        
        /**
         * Listens for real-time updates to the word list and updates the local state.
         */
        function startListeningForWords() {
            if (!isAuthReady || !userId) {
                console.error("Listener do Firestore tentado antes de o ID do usu√°rio estar definido.");
                return;
            }

            const wordsCollection = collection(db, getWordCollectionPath());
            const q = query(wordsCollection);

            onSnapshot(q, (snapshot) => {
                allWords = []; // Atualiza o estado global
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allWords.push({ id: doc.id, ...data });
                });
                
                // NOVO: Renderiza a lista aplicando o filtro atual
                applyFilterAndRender(); 
                
            }, (error) => {
                console.error("Erro ao ouvir updates do Firestore:", error);
                if (error.code === 'permission-denied') {
                    console.error("üö® ERRO CR√çTICO: PERMISS√ÉO NEGADA (RULES). As regras do Firestore n√£o permitem este acesso. Certifique-se de que publicou as regras corretamente.");
                    document.getElementById('loading').innerHTML = '<p class="text-red-600 font-bold">ERRO: Permiss√£o Negada (Regras do Firestore). Por favor, verifique se publicou as regras no console do Firebase.</p>';
                } else {
                    document.getElementById('loading').innerHTML = `<p class="text-red-600">Erro de Conex√£o: ${error.code}</p>`;
                }
            });
        }
        
        /**
         * NOVO: Aplica o filtro atual e gerencia os estilos dos bot√µes.
         */
        function applyFilterAndRender(filter = currentFilter) {
            currentFilter = filter;
            
            // 1. Atualiza o estilo dos bot√µes
            document.querySelectorAll('.filter-btn').forEach(btn => {
                // Remove estilos ativos e inativos
                btn.classList.remove('bg-gray-700', 'bg-blue-600', 'hover:bg-blue-700', 'bg-yellow-500', 'hover:bg-yellow-600', 'bg-green-500', 'hover:bg-green-600');
                btn.classList.add('text-white'); // Garante que a cor do texto √© branca
                
                if (btn.dataset.filter === filter) {
                    btn.classList.add('bg-gray-700'); // Estado Ativo (cinzento escuro)
                } else {
                    // Estado Inativo - restaurar cores originais
                    if (btn.dataset.filter === 'all') {
                        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    } else if (btn.dataset.filter === 'due') {
                        btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    } else if (btn.dataset.filter === 'mastered') {
                        btn.classList.add('bg-green-500', 'hover:bg-green-600');
                    }
                }
            });
            
            // 2. Renderiza a lista filtrada
            renderWordList(allWords);
        }

        /**
         * Renders the list of words in the table (now accepts and applies filtering).
         */
        function renderWordList(words) {
            const wordListBody = document.getElementById('word-list');
            wordListBody.innerHTML = ''; // Clear existing list

            // 1. Filtra as palavras baseadas no estado global `currentFilter`
            const filteredWords = words.filter(word => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'mastered') return word.isMastered;
                if (currentFilter === 'due') {
                    return isReviewDue(word.lastReviewDate, word.nextReviewDay);
                }
                return true;
            });

            // 2. Classifica as palavras: Urgente > Para Hoje > Pr√≥xima > Dominada
            const sortedWords = filteredWords.sort((a, b) => {
                const aDue = isReviewDue(a.lastReviewDate, a.nextReviewDay);
                const bDue = isReviewDue(b.lastReviewDate, b.nextReviewDay);

                // Coloca as dominadas no fim
                if (a.isMastered !== b.isMastered) return a.isMastered ? 1 : -1;
                // Coloca as que est√£o para revis√£o √† frente
                if (aDue !== bDue) return aDue ? -1 : 1;
                // Ordena por pr√≥xima data de revis√£o
                if (a.nextReviewDay !== b.nextReviewDay) return a.nextReviewDay - b.nextReviewDay;
                return 0;
            });

            if (sortedWords.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            sortedWords.forEach(word => {
                const row = wordListBody.insertRow();
                row.className = 'hover:bg-gray-50';

                // 1. Word Column
                row.insertCell().innerHTML = `<span class="font-bold text-gray-900">${word.word}</span>`;

                // 2. Next Review Column (Spaced Repetition Status)
                row.insertCell().innerHTML = formatNextReview(word);

                // 3. Multisensory Encoding (The "Four-Way-Use" Challenge)
                const encodingCell = row.insertCell();
                encodingCell.className = 'px-2 py-4 whitespace-nowrap text-sm text-gray-500';
                encodingCell.innerHTML = `
                    <div class="flex flex-wrap gap-2 text-xs">
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-field="seen" ${word.seen ? 'checked' : ''} class="encoding-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-id="${word.id}">
                            <span class="ml-1">Vi</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-field="heard" ${word.heard ? 'checked' : ''} class="encoding-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-id="${word.id}">
                            <span class="ml-1">Ouvi</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-field="said" ${word.said ? 'checked' : ''} class="encoding-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-id="${word.id}">
                            <span class="ml-1">Falei</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-field="written" ${word.written ? 'checked' : ''} class="encoding-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-id="${word.id}">
                            <span class="ml-1">Escrevi</span>
                        </label>
                    </div>
                `;

                // 4. Retrieval Practice (Challenge Button)
                const challengeCell = row.insertCell();
                challengeCell.className = 'px-2 py-4 whitespace-nowrap text-sm';
                challengeCell.innerHTML = `
                    <button data-word-id="${word.id}" data-word="${word.word}" data-context="${word.context}"
                        class="recall-btn px-3 py-1 bg-teal-500 text-white text-xs font-semibold rounded-full hover:bg-teal-600 transition duration-150">
                        Desafiar Mem√≥ria
                    </button>
                `;

                // 5. Actions (Complete Review / Delete)
                const actionsCell = row.insertCell();
                actionsCell.className = 'px-2 py-4 whitespace-nowrap text-right text-sm font-medium';
                actionsCell.innerHTML = `
                    ${!word.isMastered ?
                        `<button onclick="window.completeReview('${word.id}', ${word.reviewCount})"
                            class="text-green-600 hover:text-green-900 font-semibold mr-2 transition duration-150">
                            Revisado!
                        </button>` : `<span class="text-gray-400">Completo</span>`
                    }
                    <button onclick="window.showDeleteConfirmation('${word.id}', '${word.word}')"
                        class="text-red-600 hover:text-red-900 transition duration-150">
                        Deletar
                    </button>
                `;
            });

            // Reattach event listeners for dynamic content
            attachEventListeners();
        }

        // --- Event Listeners and UI Logic ---

        function attachEventListeners() {
            // Form submission for adding new words
            document.getElementById('add-word-form').onsubmit = (e) => {
                e.preventDefault();
                const word = document.getElementById('word-input').value;
                const context = document.getElementById('context-input').value;

                if (word && context) {
                    addWord(word, context);
                    document.getElementById('add-word-form').reset();
                } else {
                    console.error('Erro: Por favor, preencha a palavra E o contexto.');
                }
            };

            // Encoding Checkbox handling
            document.querySelectorAll('.encoding-checkbox').forEach(checkbox => {
                checkbox.onchange = (e) => {
                    const id = e.target.dataset.id;
                    const field = e.target.dataset.field;
                    const checked = e.target.checked;
                    updateEncoding(id, field, checked);
                };
            });

            // NOVO: Filter Controls handling
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = (e) => applyFilterAndRender(e.target.dataset.filter);
            });

            // Retrieval Practice Modal handling
            const modal = document.getElementById('context-modal');
            const modalWordEl = document.getElementById('modal-word');
            const modalContextEl = document.getElementById('modal-context');
            const hiddenContextEl = document.getElementById('modal-hidden-context');
            const showContextBtn = document.getElementById('show-context-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            
            // Delete Confirmation Modal Listeners
            document.getElementById('confirm-delete-btn').onclick = executeDeleteWord;
            document.getElementById('cancel-delete-btn').onclick = () => {
                document.getElementById('delete-confirm-modal').classList.add('hidden');
                wordToDeleteInfo = null;
            };


            document.querySelectorAll('.recall-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const word = e.target.dataset.word;
                    const context = e.target.dataset.context;

                    modalWordEl.textContent = word;
                    modalContextEl.textContent = context;
                    hiddenContextEl.classList.add('hidden');
                    modal.classList.remove('hidden');

                    showContextBtn.textContent = 'Mostrar Contexto / Confirmar Resposta';
                    showContextBtn.onclick = () => {
                        hiddenContextEl.classList.remove('hidden');
                        showContextBtn.textContent = 'Feche para continuar (Respondeu?)';
                    };
                };
            });

            closeModalBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // Expose functions to window scope for onclick attributes in dynamic HTML
        window.completeReview = completeReview;
        window.showDeleteConfirmation = showDeleteConfirmation;

        // Start the application
        document.getElementById('loading').classList.remove('hidden');
        initializeFirebase();

    </script>
</body>
</html>
